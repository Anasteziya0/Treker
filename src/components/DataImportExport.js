import { useState } from 'react';
import './DataImportExport.css';

function DataImportExport({ technologies, onImport }) {
  const [status, setStatus] = useState('');
  const [isDragging, setIsDragging] = useState(false);

  // —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ JSON-—Ñ–∞–π–ª
  const exportToJSON = () => {
    try {
      // –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ JSON-—Å—Ç—Ä–æ–∫—É —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
      const dataStr = JSON.stringify(technologies, null, 2);

      // —Å–æ–∑–¥–∞–µ–º Blob –æ–±—ä–µ–∫—Ç –∏–∑ —Å—Ç—Ä–æ–∫–∏
      const dataBlob = new Blob([dataStr], { type: 'application/json' });

      // —Å–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `technologies_${new Date().toISOString().split('T')[0]}.json`;

      // –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ –∫–ª–∏–∫–∞–µ–º –ø–æ —Å—Å—ã–ª–∫–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      // –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å
      URL.revokeObjectURL(url);

      setStatus('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ JSON —Ñ–∞–π–ª');
      setTimeout(() => setStatus(''), 3000);
    } catch (error) {
      setStatus('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö');
      console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
    }
  };

  // –∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON-—Ñ–∞–π–ª–∞
  const importFromJSON = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();

    // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞
    reader.onload = (e) => {
      try {
        const imported = JSON.parse(e.target.result);

        // –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - —ç—Ç–æ –º–∞—Å—Å–∏–≤
        if (!Array.isArray(imported)) {
          throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
        }

        // –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
        const isValid = imported.every(item => 
          item.title && 
          typeof item.title === 'string' &&
          item.category &&
          typeof item.category === 'string'
        );

        if (!isValid) {
          throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö');
        }

        onImport(imported);
        setStatus(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${imported.length} —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π`);
        setTimeout(() => setStatus(''), 3000);
      } catch (error) {
        setStatus('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
        console.error('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:', error);
      }
    };

    // –∑–∞–ø—É—Å–∫–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∫–∞–∫ —Ç–µ–∫—Å—Ç–∞
    reader.readAsText(file);

    // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ input –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞
    event.target.value = '';
  };

  // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ drag-and-drop
  const handleDragOver = (e) => {
    e.preventDefault();
    setIsDragging(true);
  };

  const handleDragLeave = () => {
    setIsDragging(false);
  };

  const handleDrop = (e) => {
    e.preventDefault();
    setIsDragging(false);

    const file = e.dataTransfer.files[0];
    if (file && file.type === 'application/json') {
      // –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É —á—Ç–µ–Ω–∏—è —á—Ç–æ –∏ –≤ importFromJSON
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const imported = JSON.parse(event.target.result);
          if (Array.isArray(imported)) {
            onImport(imported);
            setStatus(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${imported.length} —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π (–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º)`);
            setTimeout(() => setStatus(''), 3000);
          }
        } catch (error) {
          setStatus('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
        }
      };
      reader.readAsText(file);
    } else {
      setStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ JSON —Ñ–∞–π–ª');
      setTimeout(() => setStatus(''), 3000);
    }
  };

  return (
    <div className="data-import-export">
      <h2>–ò–º–ø–æ—Ä—Ç –∏ —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h2>
      
      {/* —Å—Ç–∞—Ç—É—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ */}
      <div 
        className="status-message" 
        role="status"
        aria-live="polite"
        aria-atomic="true"
      >
        {status}
      </div>

      <div className="controls">
        <button 
          onClick={exportToJSON} 
          disabled={technologies.length === 0}
          className="btn-export"
          aria-label="–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ JSON —Ñ–∞–π–ª"
        >
          üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON
        </button>

        <label className="file-input-label" aria-label="–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON —Ñ–∞–π–ª–∞">
          <input
            type="file"
            accept=".json"
            onChange={importFromJSON}
            aria-label="–í—ã–±–µ—Ä–∏—Ç–µ JSON —Ñ–∞–π–ª –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞"
          />
          <span className="btn-import">üì§ –ò–º–ø–æ—Ä—Ç –∏–∑ JSON</span>
        </label>
      </div>

      <div
        className={`drop-zone ${isDragging ? 'dragging' : ''}`}
        onDragOver={handleDragOver}
        onDragLeave={handleDragLeave}
        onDrop={handleDrop}
        role="region"
        aria-label="–û–±–ª–∞—Å—Ç—å –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤"
        tabIndex="0"
      >
        <p>üìÅ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ JSON-—Ñ–∞–π–ª —Å—é–¥–∞</p>
        <p className="hint">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞</p>
      </div>

      {technologies.length > 0 && (
        <div className="info">
          <p><strong>–í—Å–µ–≥–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π:</strong> {technologies.length}</p>
          <p><strong>–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö:</strong> –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –ø–æ–ª—è–º–∏ title, description, category, status –∏ —Ç.–¥.</p>
        </div>
      )}
    </div>
  );
}

export default DataImportExport;